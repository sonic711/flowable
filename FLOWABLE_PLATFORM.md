# Flowable API 平台需求說明

## 產品願景
建置一個統一的 Flowable API 平台，將 Flowable Engine 的所有能力以穩定、安全、可觀測的 REST 介面提供前端與外部系統使用，並確保所有進入平台的請求都可追蹤與重播。

## 功能範疇
1. **流程定義管理**
   - 上傳 / 更新 / 版本控管 BPMN、DMN、CMMN、表單等資源
   - 驗證與模擬流程定義
   - 部署狀態追蹤與回滾
2. **流程啟動與執行**
   - 依流程定義啟動新實例（含多租戶支援）
   - 動態設定啟動參數、變數與候選人
   - 支援同步 / 非同步觸發與訊息事件
3. **任務管理**
   - 代辦 / 已辦任務查詢、指派、代理、釋放
   - 批次操作與 SLA / 逾時監控
   - 任務附件、評論與表單資料存取
4. **變數與資料快照**
   - 讀寫流程 / 任務 / 全域變數
   - 變數快照、差異比較與審計追蹤
5. **歷史與稽核**
   - 流程執行歷史、事件、活動路徑查詢
   - 導出稽核報表與可視化追蹤
6. **決策與規則服務**
   - DMN 決策表部署、測試與執行 API
   - 規則版本控管與AB測試
7. **事件與整合**
   - 事件訂閱、Webhook、訊息佇列整合
   - 與外部任務、connector、RPA、資料整合
8. **使用者與授權**
   - 整合內部 IAM / OAuth2 / JWT 驗證
   - 權限模型（角色、群組、租戶）
   - API 金鑰管理與節流
9. **監管與維運**
   - 健康檢查、指標、警示與自動化恢復
   - 配置管理、環境分層與多租戶隔離
10. **開發者體驗**
    - OpenAPI 規格、SDK、自動化測試範本
    - 沙盒環境與模擬資料

## 前端請求留存策略
- 於 API Gateway / BFF 層記錄每筆請求與回應（含 header、payload、呼叫者資訊、traceId）
- 保存原始請求於可搜尋的儲存體（例如 Object Storage + 索引服務）並設定資料保留政策
- 提供查詢 / 比對介面，支援依流程實例、任務、使用者、時間範圍檢索
- 針對敏感資訊進行遮罩與加密，符合稽核與資安要求
- 建立重播機制，可將留存請求重新送入流程以協助除錯與回溯

## 開發與維護紀錄
- 2024-xx-xx：建立初版需求清單與請求留存策略描述。

## 開發步驟與測試策略
1. **流程定義生命週期 API**
   - 開發內容：實作上傳、驗證、部署 BPMN/DMN 資源的 REST 介面，並為每個部署維護狀態與回滾資訊。
   - 測試方式：單元測試驗證 payload 與 schema；整合測試部署範例流程並驗證 Flowable repository 中的版本；回滾測試在連續部署 v1/v2 後還原至 v1 並確認 active definition id。
2. **流程啟動與執行服務**
   - 開發內容：提供多租戶啟動 API，支援動態變數/候選人設定，以及同步、非同步與訊息事件觸發。
   - 測試方式：契約測試針對不同 tenant header 送出啟動請求並驗證 runtime 資料；檢查變數與候選人寫入；以訊息事件模擬非同步觸發並確認佇列執行結果。
3. **任務管理模組**
   - 開發內容：建置代辦/已辦查詢、指派/代理/釋放動作、批次處理、SLA 監控，以及附件/評論/表單 API。
   - 測試方式：情境測試啟動含使用者任務的流程，依序 claim/delegate/release 並驗證歷史紀錄與 SLA 定時器；附件上傳測試確認檔案存放與權限。
4. **變數與快照服務**
   - 開發內容：提供流程/任務/全域變數 CRUD，並可建立快照、比較差異與輸出稽核紀錄。
   - 測試方式：API 測試寫入多型別資料並讀取；在變更前後建立快照並比較差異；查詢審計記錄時確認敏感欄位遮罩。
5. **歷史與稽核查詢**
   - 開發內容：提供流程歷程、事件、活動路徑的查詢介面與稽核報表導出。
   - 測試方式：預載歷史資料後驗證依時間/使用者/流程的查詢條件；導出 CSV/JSON 報表並比對欄位結構。
6. **決策與規則服務**
   - 開發內容：DMN 決策表部署、測試執行 API、版本控管與 AB 測試切換。
   - 測試方式：單元測試 DMN 評估結果；整合測試在 AB 模式下確認流量比例與紀錄；停用 AB 後驗證僅有 active 版本被呼叫。
7. **事件與整合介面**
   - 開發內容：實作事件訂閱、Webhook、訊息佇列 connector 與外部任務橋接。
   - 測試方式：建立假 Webhook 端點檢查重試/退避；發送訊息至 MQ 並驗證消費者收到；模擬 external task worker 的 lock/complete 生命週期。
8. **身份與授權管理**
   - 開發內容：整合 IAM/OAuth2/JWT，實作角色/群組/租戶權限與 API 金鑰節流。
   - 測試方式：資安測試驗證 token 與角色控制；負載測試節流策略；負面測試確保租戶隔離。
9. **監管與維運**
   - 開發內容：健康檢查、指標、警示、自動回復，以及配置管理與多租戶隔離。
   - 測試方式：故障注入讓下游服務失效並檢查健康狀態；驗證指標可被監控系統抓取；審查配置變更紀錄。
10. **開發者體驗與請求重播**
    - 開發內容：發布 OpenAPI/SDK、自動化測試範本、沙盒資料，以及請求留存/搜尋/遮罩/加密與重播機制。
    - 測試方式：以 OpenAPI 產生契約測試並執行；使用 SDK 範例應用程式走完流程；寫入並查詢留存請求確認遮罩與加密；重播請求比對流程結果。
